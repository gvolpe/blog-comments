<!DOCTYPE html> <html lang="en-uk"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> NixOS: build your system on Github actions! &bull; gvolpe's blog </title> <meta name="description" content="What if I told you that you can save plenty of time and CPU-power by pre-building your entire NixOS configuration on Github actions? Fresh installations coul..."> <link rel="stylesheet" href="/blog/css/main.css"> <link rel="canonical" href="https://gvolpe.github.io/blog/nixos-binary-cache-ci/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <script defer type="text/javascript" src="https://api.pirsch.io/pirsch.js" id="pirschjs" data-code="db2twsz97grcqToSsEMhvcQXm8rLaFmQ"> </script> </head> <body class="single"> <main class="main"> <header class="header"> <div class="overlay"> <div class="container"> <h1 class="title"> <a href="/blog/">gvolpe's blog</a> </h1> <nav class="navbar"> <a href="#" class="menu-icon"> <span></span> <span></span> <span></span> </a> <ul class="nav"> <li><a href="https://gvolpe.com" target="_blank">Website</a></li> </ul> </nav> </div> </div> </header> <article class="post container card"> <header class="post-header"> <h1 class="post-title">NixOS: build your system on Github actions!</h1> <span class="post-meta"> <time class="post-date" datetime="2021-08-23">Aug 23, 2021</time> <span class="post-author">by Gabriel Volpe</span> </span> </header> <div class="post-content"> <p>What if I told you that you can save plenty of time and CPU-power by pre-building your <em>entire</em> <a href="https://nixos.org/">NixOS</a> configuration on Github actions? Fresh installations could be super fast and pre-validated on a CI build!</p> <p>Well, itâ€™s possible, and itâ€™s what Iâ€™m <a href="https://github.com/gvolpe/nix-config">currently doing</a> with my NixOS and <a href="https://github.com/nix-community/home-manager">Home Manager</a> configurations.</p> <p><img src="../images/ci-badges.png" alt="badges" /></p> <p>Besides hosting your configuration on Github, youâ€™ll need a binary cache where the results of your build can be pushed to be re-used later on. One of the best free alternatives is <a href="https://www.cachix.org/">Cachix</a>, offering up to 10GB on their basic tier.</p> <h3 id="home-manager">Home Manager</h3> <p>My Home Manager configuration builds in about 5 minutes.</p> <p><img src="../images/ci-home.png" alt="home" /></p> <p>Hereâ€™s the CI job definition for my home configuration.</p> <div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">runs-on</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-18.04</span>
    <span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">uses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">actions/checkout@v2.3.2</span>

      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Get</span><span class="nv"> </span><span class="s">pinned</span><span class="nv"> </span><span class="s">nixpkgs</span><span class="nv"> </span><span class="s">â„ï¸&quot;</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pinned_nixpkgs</span>
        <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo &quot;::set-output name=url::$(cat ./pinned/nixpkgs)&quot;</span>

      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Install</span><span class="nv"> </span><span class="s">Nix</span><span class="nv"> </span><span class="s">â„ï¸&quot;</span>
        <span class="l-Scalar-Plain">uses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cachix/install-nix-action@v13</span>
        <span class="l-Scalar-Plain">with</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">nix_path</span><span class="p-Indicator">:</span> <span class="s">&quot;nixpkgs=$</span><span class="err">\</span><span class="s">{</span><span class="err">\</span><span class="s">{</span><span class="nv"> </span><span class="s">steps.pinned_nixpkgs.outputs.url</span><span class="nv"> </span><span class="err">\</span><span class="s">}}&quot;</span>

      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Install</span><span class="nv"> </span><span class="s">Cachix</span><span class="nv"> </span><span class="s">â„ï¸&quot;</span>
        <span class="l-Scalar-Plain">uses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cachix/cachix-action@v10</span>
        <span class="l-Scalar-Plain">with</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gvolpe-nixos</span>
          <span class="l-Scalar-Plain">authToken</span><span class="p-Indicator">:</span> <span class="s">&quot;$</span><span class="err">\</span><span class="s">{</span><span class="err">\</span><span class="s">{</span><span class="nv"> </span><span class="s">secrets.CACHIX_AUTH_TOKEN</span><span class="nv"> </span><span class="err">\</span><span class="s">}}&quot;</span>

      <span class="c1"># Needed because cachix is also installed by Home Manager</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Set</span><span class="nv"> </span><span class="s">priority</span><span class="nv"> </span><span class="s">flag</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">Cachix</span><span class="nv"> </span><span class="s">ğŸš©&quot;</span>
        <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nix-env --set-flag priority 0 cachix</span>

      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Build</span><span class="nv"> </span><span class="s">Home</span><span class="nv"> </span><span class="s">Manager</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">ğŸ &quot;</span>
        <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./build.sh ci-home</span></code></pre></div> <p>The first relevant part is the reading of the pinned nixpkgs file, which looks as follows:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>cat pinned/nixpkgs
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: pinned/nixpkgs
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   <span class="m">1</span>   â”‚ https://github.com/NixOS/nixpkgs/archive/8ecc61c91a5.tar.gz</code></pre></div> <p>This is then read to install Nix with this specific version.</p> <p>The second relevant part is the priority flag for Cachix. This is needed in my case, because my Home Manager configuration includes Cachix as one of the programs to install, but we already have it as part of the <code>cachix-action</code>, so we give it the priority before proceeding with the build.</p> <p>Next, the shell script does the following (in addition to the creation of some directories specific to my needs):</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix-shell -p nix-build-uncached --run nix-build-uncached</code></pre></div> <p>The <a href="https://github.com/Mic92/nix-build-uncached">nix-build-uncached</a> command saves time by not re-building whatâ€™s already present in the binary cache, which cuts about 1 minute of building time, in this case.</p> <p>It mostly accepts the same arguments as <code>nix-build</code>, so you can use it wherever you use the former. If youâ€™re familiar with it, you know it needs a <code>default.nix</code> at the root directory, if no file name is indicated. This is where it gets interesting, because we usually build our home configuration by running <code>home-manager switch</code>, so thereâ€™s no such file!</p> <p>Fortunately for us, it is possible to get a derivation out of Home Manager. First of all, we define a <code>default.nix</code> with two attributes.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{</span>
    <span class="ss">config =</span> <span class="p">{</span> <span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">home =</span> pkgs<span class="o">.</span>callPackage <span class="o">.</span><span class="l">/home</span> <span class="p">{};</span>
  <span class="ss">system =</span> pkgs<span class="o">.</span>callPackage <span class="o">.</span><span class="l">/system</span> <span class="p">{};</span>
<span class="p">}</span></code></pre></div> <p>This will allow us to build all the attributes, or just the one we are interested in. E.g.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">nix-build-uncached -A home</code></pre></div> <p>At last, hereâ€™s the derivation for Home Manager, placed under <code>home/default.nix</code>:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs <span class="p">}:</span>

<span class="k">let</span>
  <span class="ss">hm_url =</span> pkgs<span class="o">.</span>lib<span class="o">.</span>fileContents <span class="o">..</span><span class="l">/pinned/home-manager</span><span class="p">;</span>

  <span class="ss">home-manager =</span> <span class="nb">builtins</span><span class="o">.</span>fetchTarball <span class="p">{</span>
    <span class="ss">name   =</span> <span class="s2">&quot;home-manager-2021-08-21&quot;</span><span class="p">;</span>
    <span class="ss">url    =</span> hm_url<span class="p">;</span>
    <span class="ss">sha256 =</span> <span class="s2">&quot;0s8nlgrf16bz2bhnk0xrzvivagq55cifxf2p545c7n4zj9ryfkkp&quot;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="ss">evalHome =</span> <span class="nb">import</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nb">toString</span> home-manager<span class="si">}</span><span class="s2">/modules&quot;</span><span class="p">;</span>
<span class="k">in</span>
<span class="p">{</span>
  <span class="ss">home-config =</span> pkgs<span class="o">.</span>lib<span class="o">.</span>recurseIntoAttrs <span class="p">(</span>
    evalHome <span class="p">{</span>
      <span class="ss">configuration =</span> <span class="o">.</span><span class="l">/home.nix</span><span class="p">;</span>
      <span class="ss">lib =</span> pkgs<span class="o">.</span>lib<span class="p">;</span>
      <span class="ss">pkgs =</span> pkgs<span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="c1"># Allow nix to recurse into this attribute set to look for derivations</span>
  <span class="ss">recurseForDerivations =</span> <span class="no">true</span><span class="p">;</span>
<span class="p">}</span></code></pre></div> <p>The <code>pinned/home-manager</code> file is similar to the <code>pinned/nixpkgs</code> file, except it points to a specific Home Manager tarball.</p> <p>All credits go to <a href="https://github.com/zimbatm">Jonas Chevalier</a> for showing me the way!</p> <h3 id="nixos">NixOS</h3> <p>The system part is equally interesting but easier to build. It takes about 3 minutes.</p> <p><img src="../images/ci-nixos.png" alt="nixos" /></p> <p>The steps are pretty similar, except there is no need to set the priority flag for Cachix.</p> <div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;Build</span><span class="nv"> </span><span class="s">NixOS</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">â„ï¸&quot;</span>
  <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./build.sh ci-system</span></code></pre></div> <p>Next we have the derivation for the system part, defined under <code>system/default.nix</code>:</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span> pkgs <span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">system =</span> pkgs<span class="o">.</span>lib<span class="o">.</span>recurseIntoAttrs <span class="p">(</span>
    pkgs<span class="o">.</span>nixos <span class="p">[</span> <span class="o">.</span><span class="l">/configuration.nix</span> <span class="p">]</span>
  <span class="p">);</span>

  <span class="ss">recurseForDerivations =</span> <span class="no">true</span><span class="p">;</span>
<span class="p">}</span></code></pre></div> <h3 id="conclusion">Conclusion</h3> <p>Thatâ€™s all it takes to build your entire operating system and user configuration on Github actions! I find it useful to always keep my configuration up-to-date as well as speeding up big upgrades and fresh installations (which are actually more rare in my case).</p> <p>My Nix configuration files can be found at <a href="https://github.com/gvolpe/nix-config">https://github.com/gvolpe/nix-config</a>.</p> <p>Whatâ€™s stopping you from doing the same? :)</p> <p>Cheers, Gabriel.</p> <aside class="share"> <span>Share this: </span> <a href="http://twitter.com/share?text=NixOS: build your system on Github actions!&amp;url=https://gvolpe.github.io/nixos-binary-cache-ci/&amp;hashtags=scala,haskell,fp&amp;via=volpegabriel87" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fa fa-twitter-square"></i> </a> </aside> <div id="gh-comments"> <br/><br/> <h6>COMMENTS</h6> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script> <script src="/blog/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog" , "14" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </article> <footer class="footer t-center"> <div class="container"> <div class="social-icons"> <ul class="text-left"> <li><a href="https://twitter.com/volpegabriel87" target="_blank"><i class="fa fa-twitter"></i></a></li> </ul> </div> <small>&copy; 2023 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small> <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small> </div> </footer> </main> </body> </html></body></html>
<!--
// # Zetsu Jekyll theme - https://github.com/nandomoreriame/zetsu/
// by nandomoreira.me
-->
