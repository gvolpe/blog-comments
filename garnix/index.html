<!DOCTYPE html> <html lang="en-uk"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Garnix CI &bull; gvolpe's blog </title> <meta name="description" content="Introduction"> <link rel="stylesheet" href="/blog/css/main.css"> <link rel="canonical" href="https://gvolpe.github.io/blog/garnix/"> <link rel="alternate" type="application/rss+xml" title="gvolpe's blog" href="https://gvolpe.github.io/blog/feed.xml" /> <script defer type="text/javascript" src="https://api.pirsch.io/pirsch.js" id="pirschjs" data-code="db2twsz97grcqToSsEMhvcQXm8rLaFmQ"> </script> </head> <body class="single"> <main class="main"> <header class="header"> <div class="overlay"> <div class="container"> <h1 class="title"> <a href="/blog/">gvolpe's blog</a> </h1> <nav class="navbar"> <a href="#" class="menu-icon"> <span></span> <span></span> <span></span> </a> <ul class="nav"> <li><a href="https://gvolpe.com" target="_blank">Website</a></li> </ul> </nav> </div> </div> </header> <article class="post container card"> <header class="post-header"> <h1 class="post-title">Garnix CI</h1> <span class="post-meta"> <time class="post-date" datetime="2023-02-07">Feb 7, 2023</time> <span class="post-author">by Gabriel Volpe</span> </span> </header> <div class="post-content"> <h2 id="introduction">Introduction</h2> <p><a href="https://garnix.io/">Garnix</a> is a continuous integration (CI) service for Nix flakes that has been in Beta for a while. In their own words:</p> <blockquote> <p>With Nix-specific optimizations, Garnix makes CI with Nix fast ‚Äî a few seconds for no-op changes. Easy to setup, too ‚Äî if you have a flake.nix, you are ready to go. And we provide the build results as a cache, so you don‚Äôt have to build things locally. To top it all up, we run on 100% renewable energy. Because CI should bring you peace of mind.</p> </blockquote> <p>My <a href="https://github.com/settings/installations">Github settings</a> tell me I have installed the Garnix CI app in March 2022 and it‚Äôs been running alongside my GHA (Github Actions) workflows ever since. However, I haven‚Äôt really reaped its benefits until now.</p> <p>Once you install the Garnix CI app in your Github account and enable the repositories where you want it to run, you‚Äôll notice that it will automatically detect a <code>flake.nix</code> and it will evaluate its packages, dev shells, checks and NixOS configurations. Still, this is all configurable per repository via a <a href="https://github.com/gvolpe/nix-config/blob/master/garnix.yaml">garnix.yaml</a> file.</p> <p><img src="../images/garnix-app.png" alt="app" /></p> <p>The <code>homeConfigurations</code> output is <a href="https://github.com/garnix-io/issues/issues/24">not yet supported</a>, but it‚Äôs in the plans. A current workaround is to expose these as <code>packages</code> instead, as I have in my flake‚Äôs outputs.</p> <div class="highlight"><pre><code class="language-nix" data-lang="nix"><span class="p">{</span>
  <span class="ss">outputs =</span> inputs<span class="p">:</span>
    <span class="k">let</span>
      <span class="ss">system =</span> <span class="s2">&quot;x86_64-linux&quot;</span><span class="p">;</span>
      <span class="ss">ci =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/ci.nix</span> <span class="p">{</span> <span class="k">inherit</span> inputs system<span class="p">;</span> <span class="p">};</span>
      <span class="ss">home =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/home-conf.nix</span> <span class="p">{</span> <span class="k">inherit</span> inputs system<span class="p">;</span> <span class="p">};</span>
    <span class="k">in</span>
    <span class="p">{</span>
      <span class="ss">homeConfigurations =</span> home<span class="p">;</span>

      <span class="ss">nixosConfigurations =</span>
        <span class="nb">import</span> <span class="o">.</span><span class="l">/outputs/nixos-conf.nix</span> <span class="p">{</span> <span class="k">inherit</span> inputs system<span class="p">;</span> <span class="p">};</span>

      packages<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">inherit</span> <span class="p">(</span>ci<span class="p">)</span> metals metals-updater<span class="p">;</span>
        <span class="ss">home-edp =</span> home<span class="o">.</span>gvolpe-edp<span class="o">.</span>activationPackage<span class="p">;</span>
        <span class="ss">home-hdmi =</span> home<span class="o">.</span>gvolpe-hdmi<span class="o">.</span>activationPackage<span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span></code></pre></div> <p>The downside of doing this is that building the Home Manager configurations requires <a href="https://nixos.wiki/wiki/Import_From_Derivation">Import From Derivation (IFD)</a> (at least in my case) even for <code>nix flake show</code>.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix flake show --allow-import-from-derivation
git+file:///home/gvolpe/workspace/nix-config?ref<span class="o">=</span>...
‚îú‚îÄ‚îÄ‚îÄhomeConfigurations: unknown
‚îú‚îÄ‚îÄ‚îÄnixosConfigurations
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄdell-xps: NixOS configuration
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄtongfang-amd: NixOS configuration
‚îî‚îÄ‚îÄ‚îÄpackages
    ‚îî‚îÄ‚îÄ‚îÄx86_64-linux
        ‚îú‚îÄ‚îÄ‚îÄhome-edp: package <span class="s1">&#39;home-manager-generation&#39;</span>
        ‚îú‚îÄ‚îÄ‚îÄhome-hdmi: package <span class="s1">&#39;home-manager-generation&#39;</span>
        ‚îú‚îÄ‚îÄ‚îÄmetals: package <span class="s1">&#39;metals-0.11.10+111-59a1b932-SNAPSHOT&#39;</span>
        ‚îî‚îÄ‚îÄ‚îÄmetals-updater: package <span class="s1">&#39;metals-updater-script&#39;</span></code></pre></div> <p>Nevertheless, I believe the pros greatly outweigh the cons.</p> <p>Here‚Äôs the <a href="https://github.com/gvolpe/nix-config/pull/162/files">pull request</a> I made to completely remove the GHA workflows for my configuration (including Cachix) and use Garnix instead. The build times are insanely fast!</p> <p><img src="../images/garnix-actions.png" alt="actions" /></p> <p>Building my Home Manager configuration used to take about <strong>7m 30s</strong> with my previous setup. With Garnix, it built in <strong>1m 45s</strong> the first time, but it only took about <strong>26s</strong> in subsequent runs by leveraging its binary cache!</p> <p>The dashboard is quite minimalistic and could use some improvements, but the service is still in Beta :)</p> <p><img src="../images/garnix-home.png" alt="home" /></p> <p>If we click on the status of any build, we can see the logs whenever available.</p> <p><img src="../images/garnix-logs.png" alt="logs" /></p> <p>There are a few tickets raised in their <a href="https://github.com/garnix-io/issues/issues">issue tracker</a> to make it nicer and provide a better user experience, thus I believe it can only get better from now üí™</p> <h3 id="how-does-it-work">How does it work?</h3> <p>How come Garnix does so much better than using plain Nix with a binary cache? It is vaguely explained it in the <a href="https://garnix.io/docs/steps">what Garnix CI does</a> page, which I understand it involves the following steps.</p> <p>First of all, it gets all the attribute names of the supported outputs, e.g.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix <span class="nb">eval</span> .#packages.x86_64-linux --apply builtins.attrNames --json
<span class="o">[</span><span class="s2">&quot;home-edp&quot;</span>,<span class="s2">&quot;home-hdmi&quot;</span>,<span class="s2">&quot;metals&quot;</span>,<span class="s2">&quot;metals-updater&quot;</span><span class="o">]</span>

<span class="nv">$ </span>nix <span class="nb">eval</span> .#nixosConfigurations --apply builtins.attrNames --json
<span class="o">[</span><span class="s2">&quot;dell-xps&quot;</span>,<span class="s2">&quot;tongfang-amd&quot;</span><span class="o">]</span></code></pre></div> <p>According to this, supporting <code>homeConfigurations</code> should not be that hard, but there may be more to it.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix <span class="nb">eval</span> .#homeConfigurations --apply builtins.attrNames --json
<span class="o">[</span><span class="s2">&quot;gvolpe-edp&quot;</span>,<span class="s2">&quot;gvolpe-hdmi&quot;</span><span class="o">]</span></code></pre></div> <p>Next, it builds every attribute previously collected in <em>parallel</em>.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix build .#metals --json
<span class="o">[{</span><span class="s2">&quot;drvPath&quot;</span>:<span class="s2">&quot;/nix/store/4kql56jcvr6q0fihw2wqq56gqpf6h9gl-metals-0.11.10+111-59a1b932-SNAPSHOT.drv&quot;</span>,<span class="s2">&quot;outputs&quot;</span>:<span class="o">{</span><span class="s2">&quot;out&quot;</span>:<span class="s2">&quot;/nix/store/q65x0gng6ni18hfyfbshzr910vlw28rp-metals-0.11.10+111-59a1b932-SNAPSHOT&quot;</span><span class="o">}</span>,<span class="s2">&quot;startTime&quot;</span>:0,<span class="s2">&quot;stopTime&quot;</span>:0<span class="o">}]</span>

<span class="nv">$ </span>nix build .#home-hdmi --json
<span class="o">[{</span><span class="s2">&quot;drvPath&quot;</span>:<span class="s2">&quot;/nix/store/wb31m320kq32b6wvclvdwnq16kgblwz0-home-manager-generation.drv&quot;</span>,<span class="s2">&quot;outputs&quot;</span>:<span class="o">{</span><span class="s2">&quot;out&quot;</span>:<span class="s2">&quot;/nix/store/1xhxwpcsg97rgmp1hanr8lzszn3hhfd2-home-manager-generation&quot;</span><span class="o">}</span>,<span class="s2">&quot;startTime&quot;</span>:0,<span class="s2">&quot;stopTime&quot;</span>:0<span class="o">}]</span></code></pre></div> <p>Finally, it uses the derivation (<code>drvPath</code>) of the outputs to query the nix log (or other heuristics when not available). I don‚Äôt know exactly what this means, but by running the following command:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>nix show-derivation /nix/store/4kql56jcvr6q0fihw2wqq56gqpf6h9gl-metals-0.11.10+111-59a1b932-SNAPSHOT.drv</code></pre></div> <p>We get the following attributes: <code>args</code>, <code>builder</code>, <code>env</code>, <code>inputDrvs</code>, <code>inputSrcs</code>, <code>outputs</code>, and <code>system</code>. I assume it cleverly skips anything that hasn‚Äôt changed and builds only what did change, keeping the build times as short as possible, but it‚Äôs only a guess.</p> <h3 id="chat-with-julian">Chat with Julian</h3> <p>I reached out to the author of Garnix, <a href="https://github.com/jkarni">Julian Arni</a>, and he kindly got back to me with a very detailed and speedy response, answering all my silly questions. Find them adapted a bit in the following sections.</p> <h4 id="why-is-it-faster">Why is it faster?</h4> <p>There are a few reasons it‚Äôs faster:</p> <ol> <li> <p>The cache is already in the disk, so builds don‚Äôt need to push and pull from the cache. Pulling, in particular, tends to take quite a long time, since essentially nothing is there yet. I‚Äôve seen 4-5 minutes of 20 minute CI runs be due to that. By default, Nix will pull even if nothing needs to be built, so even in ‚Äúdo nothing‚Äù runs you might end up paying that cost.</p> </li> <li> <p>The cache can be shared across projects. With Cachix, each cache is kept separate, because the cache owner can push whatever they want to their cache. Garnix only allows builds that are pure by design, and that it itself has built, to enter the cache. This way, if any project or user has built the package, it‚Äôs safe to re-use those artifacts. This is a lot like the <code>cache.nixos.org</code> builders, and it becomes particularly helpful if packages you depend on are also using Garnix; but even more significant with forks.</p> </li> <li> <p>Garnix has more powerful machines than Github, and that in turn, enables higher <strong>parallelism</strong>. Additionally, rather than vCPUs, we use CPU shares. The idea is, if the machine is not busy, you get a really fast machine; that works well for everyone, since then your build is done sooner and the machine is again free (or free-er) for the next build. Throttling the CPU is terrible for overall latency, and the only advantages I can see are more predictable times for users, and easier implementation if you‚Äôre using bin-packing schedulers/orchestrators.</p> </li> </ol> <h4 id="whats-the-cache-retention-policy">What‚Äôs the cache retention policy?</h4> <p>Regarding the cache, it just serves its own Nix store. A clear retention policy is still in the works, so relying on the cache being available longer term would be a bad idea. However, the current idea looks as follows:</p> <ul> <li>2-3 days for commits that are no longer the head of any branch.</li> <li>2 weeks for the head of non-main branches</li> <li>2-3 months for the head of <code>main</code> / <code>master</code>.</li> </ul> <p>Once this is determined, it should be properly documented.</p> <h3 id="alternatives">Alternatives</h3> <p>The obvious alternative is Github Actions, which I just migrated away from. Furthermore, there‚Äôs also <a href="https://nixbuild.net/">Nixbuild</a>, which is much more than a CI service, but I plan to cover it in a follow-up blog post as I‚Äôm still experimenting with it.</p> <h3 id="final-words">Final words</h3> <p>Garnix is a very promising piece of software that can save you plenty of time. If you also enjoy using it and would like to see it succeed like I do, please consider <a href="https://opencollective.com/garnix_io">donating</a>.</p> <p>Julian has also acknowledged that the sign-up process is still a bit confusing, so there are plans to improve it, but honestly I can‚Äôt remember about it since I‚Äôve signed up a year ago. If you are giving Garnix a try and find this to be the case, feel free to share your ideas to make it better in their issue tracker.</p> <p>Best, Gabriel.</p> <aside class="share"> <span>Share this: </span> <a href="http://twitter.com/share?text=Garnix CI&amp;url=https://gvolpe.github.io/garnix/&amp;hashtags=scala,haskell,fp&amp;via=volpegabriel87" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fa fa-twitter-square"></i> </a> </aside> <div id="gh-comments"> <br/><br/> <h6>COMMENTS</h6> <div id="gh-comments-list"></div> </div> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script> <script src="/blog/js/github-comments.js"> </script> <script type="text/javascript"> DoGithubComments ( "gvolpe/blog" , "22" ); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> </article> <footer class="footer t-center"> <div class="container"> <div class="social-icons"> <ul class="text-left"> <li><a href="https://twitter.com/volpegabriel87" target="_blank"><i class="fa fa-twitter"></i></a></li> </ul> </div> <small>&copy; 2023 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small> <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small> </div> </footer> </main> </body> </html></body></html>
<!--
// # Zetsu Jekyll theme - https://github.com/nandomoreriame/zetsu/
// by nandomoreira.me
-->
